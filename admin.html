<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NautiCAI — Admin Dashboard</title>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
    <style>
        :root {
            --bg: #050a0f;
            --bg-panel: #0a1520;
            --bg-card: #0d1f2d;
            --border: #12384d;
            --border-dim: #0f2a3a;
            --teal: #00c8b0;
            --teal-dim: rgba(0, 200, 176, 0.15);
            --amber: #f0a500;
            --red: #e74c3c;
            --green: #2ecc71;
            --text-1: #e4edf4;
            --text-2: #8ea8be;
            --text-3: #4a6a80;
            --font-mono: 'JetBrains Mono', monospace;
            --font-head: 'Space Grotesk', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text-1);
            font-family: var(--font-mono);
            font-size: 13px;
            min-height: 100vh;
        }

        /* ── Auth Gate ──────────────────────────────── */
        .auth-gate {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-box {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 40px;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .auth-box h1 {
            font-family: var(--font-head);
            font-size: 22px;
            color: var(--teal);
            margin-bottom: 6px;
        }

        .auth-box p {
            color: var(--text-3);
            font-size: 12px;
            margin-bottom: 24px;
        }

        .auth-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-1);
            font-family: var(--font-mono);
            font-size: 14px;
            border-radius: 4px;
            margin-bottom: 16px;
            outline: none;
        }

        .auth-input:focus {
            border-color: var(--teal);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: var(--teal);
            color: #050a0f;
            font-family: var(--font-mono);
            font-size: 13px;
            font-weight: 700;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            letter-spacing: 0.5px;
        }

        .auth-btn:hover {
            background: #00e0c4;
        }

        .auth-error {
            color: var(--red);
            font-size: 12px;
            margin-top: 12px;
            display: none;
        }

        /* ── Layout ─────────────────────────────────── */
        .admin-wrap {
            display: none;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 28px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
        }

        .topbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .topbar-brand img {
            height: 32px;
        }

        .topbar-brand h1 {
            font-family: var(--font-head);
            font-size: 18px;
            color: var(--teal);
        }

        .topbar-brand span {
            color: var(--text-3);
            font-size: 11px;
            margin-left: 8px;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .topbar-stat {
            font-size: 11px;
            color: var(--text-2);
        }

        .topbar-stat strong {
            color: var(--teal);
        }

        .btn-logout {
            padding: 6px 14px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-2);
            font-family: var(--font-mono);
            font-size: 11px;
            cursor: pointer;
            border-radius: 3px;
        }

        .btn-logout:hover {
            border-color: var(--red);
            color: var(--red);
        }

        .main {
            padding: 28px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ── Tabs ────────────────────────────────────── */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--text-2);
            font-family: var(--font-mono);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--bg-card);
            border-color: var(--teal);
            color: var(--teal);
            border-bottom-color: var(--bg-card);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text-1);
        }

        .tab-count {
            background: var(--teal-dim);
            color: var(--teal);
            padding: 1px 7px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 8px;
        }

        /* ── Toolbar ─────────────────────────────────── */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            padding: 9px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-1);
            font-family: var(--font-mono);
            font-size: 12px;
            border-radius: 4px;
            outline: none;
        }

        .search-input:focus {
            border-color: var(--teal);
        }

        .filter-select {
            padding: 9px 12px;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text-1);
            font-family: var(--font-mono);
            font-size: 12px;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }

        .btn-refresh {
            padding: 9px 16px;
            background: var(--teal-dim);
            border: 1px solid var(--teal);
            color: var(--teal);
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 4px;
        }

        .btn-refresh:hover {
            background: var(--teal);
            color: #050a0f;
        }

        /* ── Table ───────────────────────────────────── */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-3);
            padding: 10px 14px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-panel);
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .data-table td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-dim);
            font-size: 12px;
            color: var(--text-2);
            vertical-align: middle;
        }

        .data-table tr:hover td {
            background: rgba(0, 200, 176, 0.03);
        }

        .table-wrap {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: auto;
            max-height: 70vh;
        }

        /* ── Badges ──────────────────────────────────── */
        .risk-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .risk-HIGH {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .risk-MEDIUM {
            background: rgba(240, 165, 0, 0.15);
            color: #f0a500;
            border: 1px solid rgba(240, 165, 0, 0.3);
        }

        .risk-LOW,
        .risk-SAFE {
            background: rgba(0, 200, 176, 0.15);
            color: #00c8b0;
            border: 1px solid rgba(0, 200, 176, 0.3);
        }

        .use-case-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            background: var(--teal-dim);
            color: var(--teal);
            border: 1px solid rgba(0, 200, 176, 0.2);
        }

        /* ── Delete btn ──────────────────────────────── */
        .btn-delete {
            padding: 4px 10px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-3);
            font-family: var(--font-mono);
            font-size: 10px;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            border-color: var(--red);
            color: var(--red);
            background: rgba(231, 76, 60, 0.08);
        }

        /* ── Empty state ─────────────────────────────── */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-3);
            font-size: 13px;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        /* ── Stats bar ───────────────────────────────── */
        .stats-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 140px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 16px 20px;
        }

        .stat-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.7px;
            color: var(--text-3);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--teal);
            font-family: var(--font-head);
        }

        /* ── Responsive ──────────────────────────────── */
        @media (max-width: 768px) {
            .topbar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .toolbar {
                flex-direction: column;
            }

            .stats-bar {
                flex-direction: column;
            }
        }

        /* ── Loading spinner ─────────────────────────── */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--teal);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 6px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ── Truncated text ──────────────────────────── */
        .truncate {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .truncate-sm {
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ── Image thumbnail ─────────────────────────── */
        .thumb {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .thumb:hover {
            border-color: var(--teal);
            box-shadow: 0 0 12px rgba(0, 200, 176, 0.3);
        }
    </style>
</head>

<body>

    <!-- ═══════ AUTH GATE ═══════ -->
    <div class="auth-gate" id="auth-gate">
        <div class="auth-box">
            <h1>NautiCAI Admin</h1>
            <p>Enter admin credentials to access the dashboard</p>
            <input type="email" class="auth-input" id="auth-email" placeholder="admin@nauticai.com" value="" />
            <input type="password" class="auth-input" id="auth-password" placeholder="Password" />
            <button class="auth-btn" onclick="attemptLogin()">Access Dashboard</button>
            <div class="auth-error" id="auth-error">Invalid credentials</div>
        </div>
    </div>

    <!-- ═══════ ADMIN DASHBOARD ═══════ -->
    <div class="admin-wrap" id="admin-wrap">

        <!-- Top bar -->
        <div class="topbar">
            <div class="topbar-brand">
                <img src="image.png" alt="NautiCAI" onerror="this.style.display='none'" />
                <h1>Admin Console</h1>
                <span>v1.0</span>
            </div>
            <div class="topbar-right">
                <div class="topbar-stat">Inspections: <strong id="stat-inspections">—</strong></div>
                <div class="topbar-stat">Contacts: <strong id="stat-contacts">—</strong></div>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="main">

            <!-- Stats -->
            <div class="stats-bar" id="stats-bar">
                <div class="stat-card">
                    <div class="stat-label">Total Inspections</div>
                    <div class="stat-value" id="sv-inspections">—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">High Risk</div>
                    <div class="stat-value" id="sv-high" style="color:#e74c3c;">—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Enterprise Contacts</div>
                    <div class="stat-value" id="sv-contacts">—</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Confidence</div>
                    <div class="stat-value" id="sv-avg-conf">—</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" id="tab-inspections" onclick="switchTab('inspections')">
                    Inspections <span class="tab-count" id="tc-inspections">0</span>
                </button>
                <button class="tab-btn" id="tab-contacts" onclick="switchTab('contacts')">
                    Enterprise Contacts <span class="tab-count" id="tc-contacts">0</span>
                </button>
            </div>

            <!-- ═══ INSPECTIONS TAB ═══ -->
            <div id="panel-inspections">
                <div class="toolbar">
                    <input type="text" class="search-input" id="search-inspections"
                        placeholder="Search inspections by ID, file name, classes…" oninput="filterInspections()" />
                    <select class="filter-select" id="filter-risk" onchange="filterInspections()">
                        <option value="">All Risk Levels</option>
                        <option value="HIGH">HIGH</option>
                        <option value="MEDIUM">MEDIUM</option>
                        <option value="LOW">LOW</option>
                        <option value="SAFE">SAFE</option>
                    </select>
                    <button class="btn-refresh" onclick="loadInspections()"><span class="spinner" id="spin-insp"
                            style="display:none;"></span>Refresh</button>
                </div>
                <div class="table-wrap">
                    <table class="data-table" id="table-inspections">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Inspection ID</th>
                                <th>File</th>
                                <th>Detected Classes</th>
                                <th>Risk</th>
                                <th>Confidence</th>
                                <th>Inference</th>
                                <th>Date</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tbody-inspections"></tbody>
                    </table>
                </div>
            </div>

            <!-- ═══ CONTACTS TAB ═══ -->
            <div id="panel-contacts" style="display:none;">
                <div class="toolbar">
                    <input type="text" class="search-input" id="search-contacts"
                        placeholder="Search contacts by name, email, company…" oninput="filterContacts()" />
                    <select class="filter-select" id="filter-usecase" onchange="filterContacts()">
                        <option value="">All Use Cases</option>
                        <option value="Ship Hull Inspection">Ship Hull</option>
                        <option value="Subsea Pipeline">Pipeline</option>
                        <option value="Offshore Wind Foundation">Wind</option>
                        <option value="Port & Harbor">Port</option>
                        <option value="Other">Other</option>
                    </select>
                    <button class="btn-refresh" onclick="loadContacts()"><span class="spinner" id="spin-cont"
                            style="display:none;"></span>Refresh</button>
                </div>
                <div class="table-wrap">
                    <table class="data-table" id="table-contacts">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Company</th>
                                <th>Use Case</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tbody-contacts"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        /* ═══════════════════════════════════════════
           NautiCAI Admin — Supabase Direct Client
        ═══════════════════════════════════════════ */

        const SUPABASE_URL = 'https://pfecxmgqmtsjmkyqutmk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBmZWN4bWdxbXRzam1reXF1dG1rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MjMyMjMsImV4cCI6MjA4NzA5OTIyM30.90Pzb2JbseLrQKECANEtVT-qGDVMCNvy_h0HlEnZkTQ';

        let sb = null;        // Supabase client — init after auth
        let inspections = [];
        let contacts = [];

        /* ── Auth ──────────────────────────────────── */
        async function attemptLogin() {
            const email = document.getElementById('auth-email').value.trim();
            const pass = document.getElementById('auth-password').value;
            const errEl = document.getElementById('auth-error');
            errEl.style.display = 'none';

            if (!email || !pass) {
                errEl.textContent = 'Please enter email and password';
                errEl.style.display = 'block';
                return;
            }

            try {
                const { createClient } = supabase;
                sb = createClient(SUPABASE_URL, SUPABASE_KEY);

                const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });
                if (error) throw error;

                document.getElementById('auth-gate').style.display = 'none';
                document.getElementById('admin-wrap').style.display = 'block';
                sessionStorage.setItem('admin_auth', '1');
                loadAll();
            } catch (e) {
                errEl.textContent = e.message || 'Authentication failed';
                errEl.style.display = 'block';
            }
        }

        // Allow Enter key
        document.getElementById('auth-password').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') attemptLogin();
        });

        function logout() {
            sessionStorage.removeItem('admin_auth');
            if (sb) sb.auth.signOut();
            document.getElementById('admin-wrap').style.display = 'none';
            document.getElementById('auth-gate').style.display = 'flex';
            document.getElementById('auth-password').value = '';
        }

        /* ── Tab switch ────────────────────────────── */
        function switchTab(tab) {
            document.getElementById('tab-inspections').classList.toggle('active', tab === 'inspections');
            document.getElementById('tab-contacts').classList.toggle('active', tab === 'contacts');
            document.getElementById('panel-inspections').style.display = tab === 'inspections' ? '' : 'none';
            document.getElementById('panel-contacts').style.display = tab === 'contacts' ? '' : 'none';
        }

        /* ── Load all data ─────────────────────────── */
        async function loadAll() {
            await Promise.all([loadInspections(), loadContacts()]);
        }

        /* ── Inspections ───────────────────────────── */
        async function loadInspections() {
            const spin = document.getElementById('spin-insp');
            spin.style.display = 'inline-block';

            try {
                const { data, error } = await sb
                    .from('inspections')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(200);

                if (error) throw error;
                inspections = data || [];
            } catch (e) {
                inspections = [];
                console.error('Load inspections error:', e);
            }

            spin.style.display = 'none';
            updateStats();
            filterInspections();
        }

        function filterInspections() {
            const q = (document.getElementById('search-inspections').value || '').toLowerCase();
            const risk = document.getElementById('filter-risk').value;

            const filtered = inspections.filter(r => {
                if (risk && r.risk_level !== risk) return false;
                if (q) {
                    const hay = [
                        r.inspection_id, r.file_name,
                        ...(Array.isArray(r.detected_classes) ? r.detected_classes : []),
                        r.risk_level, r.status,
                    ].join(' ').toLowerCase();
                    if (!hay.includes(q)) return false;
                }
                return true;
            });

            renderInspections(filtered);
        }

        function renderInspections(rows) {
            const tbody = document.getElementById('tbody-inspections');
            document.getElementById('tc-inspections').textContent = rows.length;

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><svg viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="24" cy="24" r="20"/><path d="M16 28 Q24 20 32 28"/></svg><p>No inspections found</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = rows.map(r => {
                const cls = Array.isArray(r.detected_classes) ? r.detected_classes.join(', ') : (r.detected_classes || '—');
                const conf = r.highest_confidence != null ? (r.highest_confidence * 100).toFixed(0) + '%' : '—';
                const inf = r.inference_time != null ? (r.inference_time * 1000).toFixed(0) + ' ms' : '—';
                const date = r.created_at ? new Date(r.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : '—';
                const thumb = r.annotated_image_url
                    ? `<img src="${r.annotated_image_url}" class="thumb" onclick="window.open('${r.annotated_image_url}','_blank')" />`
                    : (r.image_url ? `<img src="${r.image_url}" class="thumb" onclick="window.open('${r.image_url}','_blank')" />` : '<span style="color:var(--text-3)">—</span>');

                return `<tr>
          <td>${thumb}</td>
          <td style="color:var(--teal);font-weight:600;">${r.inspection_id || '—'}</td>
          <td><span class="truncate-sm" title="${r.file_name || ''}">${r.file_name || '—'}</span></td>
          <td><span class="truncate" title="${cls}">${cls}</span></td>
          <td><span class="risk-badge risk-${r.risk_level || 'SAFE'}">${r.risk_level || '—'}</span></td>
          <td style="font-weight:600;">${conf}</td>
          <td>${inf}</td>
          <td style="font-size:11px;">${date}</td>
          <td><button class="btn-delete" onclick="deleteInspection('${r.id}')">Delete</button></td>
        </tr>`;
            }).join('');
        }

        async function deleteInspection(id) {
            if (!confirm('Delete this inspection record permanently?')) return;
            try {
                await sb.from('inspections').delete().eq('id', id);
                inspections = inspections.filter(r => r.id !== id);
                updateStats();
                filterInspections();
            } catch (e) {
                alert('Delete failed: ' + e.message);
            }
        }

        /* ── Contacts ──────────────────────────────── */
        async function loadContacts() {
            const spin = document.getElementById('spin-cont');
            spin.style.display = 'inline-block';

            try {
                const { data, error } = await sb
                    .from('enterprise_contacts')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(200);

                if (error) throw error;
                contacts = data || [];
            } catch (e) {
                contacts = [];
                console.error('Load contacts error:', e);
            }

            spin.style.display = 'none';
            updateStats();
            filterContacts();
        }

        function filterContacts() {
            const q = (document.getElementById('search-contacts').value || '').toLowerCase();
            const uc = document.getElementById('filter-usecase').value;

            const filtered = contacts.filter(r => {
                if (uc && r.use_case !== uc) return false;
                if (q) {
                    const hay = [r.first_name, r.last_name, r.email, r.company, r.use_case, r.message].join(' ').toLowerCase();
                    if (!hay.includes(q)) return false;
                }
                return true;
            });

            renderContacts(filtered);
        }

        function renderContacts(rows) {
            const tbody = document.getElementById('tbody-contacts');
            document.getElementById('tc-contacts').textContent = rows.length;

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><svg viewBox="0 0 48 48" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="24" cy="24" r="20"/><path d="M16 28 Q24 20 32 28"/></svg><p>No contacts found</p></div></td></tr>';
                return;
            }

            tbody.innerHTML = rows.map(r => {
                const name = `${r.first_name || ''} ${r.last_name || ''}`.trim() || '—';
                const date = r.created_at ? new Date(r.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) : '—';
                const msg = r.message ? `<span class="truncate" title="${escHtml(r.message)}">${escHtml(r.message)}</span>` : '<span style="color:var(--text-3)">—</span>';

                return `<tr>
          <td style="font-weight:600;color:var(--text-1);">${escHtml(name)}</td>
          <td><a href="mailto:${escHtml(r.email)}" style="color:var(--teal);text-decoration:none;">${escHtml(r.email || '—')}</a></td>
          <td>${escHtml(r.company || '—')}</td>
          <td>${r.use_case ? `<span class="use-case-badge">${escHtml(r.use_case)}</span>` : '—'}</td>
          <td>${msg}</td>
          <td style="font-size:11px;">${date}</td>
          <td><button class="btn-delete" onclick="deleteContact('${r.id}')">Delete</button></td>
        </tr>`;
            }).join('');
        }

        async function deleteContact(id) {
            if (!confirm('Delete this contact record permanently?')) return;
            try {
                await sb.from('enterprise_contacts').delete().eq('id', id);
                contacts = contacts.filter(r => r.id !== id);
                updateStats();
                filterContacts();
            } catch (e) {
                alert('Delete failed: ' + e.message);
            }
        }

        /* ── Stats ─────────────────────────────────── */
        function updateStats() {
            document.getElementById('stat-inspections').textContent = inspections.length;
            document.getElementById('stat-contacts').textContent = contacts.length;
            document.getElementById('sv-inspections').textContent = inspections.length;
            document.getElementById('sv-contacts').textContent = contacts.length;

            const highRisk = inspections.filter(r => r.risk_level === 'HIGH').length;
            document.getElementById('sv-high').textContent = highRisk;

            const confs = inspections.filter(r => r.highest_confidence != null).map(r => r.highest_confidence);
            const avg = confs.length ? (confs.reduce((a, b) => a + b, 0) / confs.length * 100).toFixed(1) + '%' : '—';
            document.getElementById('sv-avg-conf').textContent = avg;
        }

        /* ── Helpers ────────────────────────────────── */
        function escHtml(s) {
            const d = document.createElement('div');
            d.textContent = s || '';
            return d.innerHTML;
        }

        /* ── Auto-session restore on page load ────── */
        (async function autoRestore() {
            try {
                const { createClient } = supabase;
                sb = createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data: { session } } = await sb.auth.getSession();
                if (session) {
                    document.getElementById('auth-gate').style.display = 'none';
                    document.getElementById('admin-wrap').style.display = 'block';
                    loadAll();
                }
            } catch (e) {
                console.log('No active session, showing login gate');
            }
        })();
    </script>

</body>

</html>